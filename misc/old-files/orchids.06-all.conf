#                                    _     _     _
#       __/\_______    ___  _ __ ___| |__ (_) __| |___   _______/\__
#  _____\    /_____|  / _ \| '__/ __| '_ \| |/ _` / __| |_____\    /_____
# |_____/_  _\_____| | (_) | | | (__| | | | | (_| \__ \ |_____/_  _\_____|
#         \/          \___/|_|  \___|_| |_|_|\__,_|___/         \/
#
# ORCHIDS Configuration file
#

# ORCHIDS Global parameters
AddModule remoteadm
AddModule textfile
AddModule sockunix
AddModule udp
AddModule syslog
AddModule rawsnare
AddModule snare
AddModule generic
AddModule netfilter
AddModule cisco
AddModule snmp
AddModule sunbsm
AddModule win32evt
AddModule consoles
AddModule autohtml

PollPeriod 30

AddRuleFile ./rules/apachessl_response.rule
AddRuleFile ./rules/pid_tracker.rule
AddRuleFile ./rules/lin24_ptrace_audit.rule
AddRuleFile ./rules/portscan.rule
AddRuleFile ./rules/dhcp_lease_check.rule

HTMLOutputDir ./html-output/

IDMEFdtd              files/idmef-message.dtd
IDMEFAnalyzerId       orchids-idmef
IDMEFAnalyzerLocation orchids-analyzer
IDMEFSensorHostname   orchids-sensor

#RuntimeUser orchids
RuntimeUser olivain

ReportDir     ./reports/
ReportPrefix  report-
ReportExt     .rpt

#
# textfile input module config
#
#<module textfile>
#  ReOpenSafetyChecks = true
#  ReOpenIntegrityChecks = crc32
#  AddInputFile /import/olivain/work/orchids/src/messages
#  AddInputFile access_log
#  AddInputFile apache_ssl
#  AddInputFile maillog
#  AddInputFile /home/olivai_j/work/orchids/src/messages
#  AddInputFile messages
#  AddInputFile maillog
#  AddInputFile ../../pcleria1-global.log
#  AddInputFile /import/olivain/temp/big-log
#  AddInputFile snare.log
#  ProceedAll 1
#  AddInputFile /var/log/maillog
#  AddInputFile /var/log/snare
#</module>

# syslog input module
<module syslog>
#  AddTextfileSource /home/olivai_j/work/orchids/src/messages
  AddTextfileSource /import/olivain/work/orchids/src/messages
  AddTextfileSource /import/olivain/work/orchids/src/maillog
  AddUdpSource 10514
  AddUdpSource 514
#  AddSource messages
  AddUnixSocketSource /dev/log
</module>

# udpsyslog input module
<module udp>
  AddListenPort 10514
#  AddListenPort 6161
  AddListenPort 6262
#  AddListenPort 6363
#  AddListenPort 514
#  AddListenPort 162
</module>

# sockunix module
<module sockunix>
  AddUnixSocket /dev/log
</module>

# consoles
#<module consoles>
#  AddConsole alert   localhost 42000
#  AddConsole warning localhost 42001
#  AddConsole info    localhost 42002
#  AddConsole msg     localhost 42003
#  AddConsole alert   blah 42012
#</module>

# remote admin module
<module remoteadm>
  ListenPort 4242
</module>

# snare module
#<module snare>
#  AddUdpSource 6161
#  AddTextfileSource /import/olivain/work/orchids/src/snare.log
#  AddTextfileSource /home/olivai_j/work/orchids/src/snare.log
#</module>

# rawsnare module
<module rawsnare>
  AddUdpSource 6262
</module>

# netfilter module
<module netfilter>
#  AddUdpSource 6363
  AddHook nfhub
</module>


# generic module
<module generic>

#
# TODO:
#  <hook syslog "*(pam_unix)">
#    <vmod pam_unix>
#    </vmod>
#  </hook>
#
#  <hook syslog "pam_access">
#    <vmod pam_access>
#    </vmod>
#  </hook>
#
# pam_rhosts_auth[3748]: allowed to root@dellpe02 as root
#


  <hook syslog "sshd">
    <vmod sshd>
      <fieldmatch "^(Accepted|Failed|Postponed) (password|publickey|hostbased) for ([^ ]+) from ([0-9.]+) port ([0-9]+) (.*)">
        str_field action 1         Authentification status
        str_field method 2         Authentification method
        str_field user 3           Current user name (login)
        ip4_field src_ip 4         IP Source address
        int_field src_port 5       TCP Source port
        str_field proto 6          Protocol version (ssh1/2)
      </fieldmatch>

      <fieldmatch "^(Accepted|Failed) (rhosts-rsa) for ([^ ]+) from ([0-9.]+) port ([0-9]+) ruser (.*)">
        str_field action 1
        str_field method 2
        str_field user 3
        ip4_field src_ip 4
        int_field src_port 5
        str_field ruser 6            Remote user name
      </fieldmatch>

      <fieldmatch "^userauth_hostbased mismatch: client sends ([^,]+), but we resolve ([0-9.]+) to (.*)">
        str_field client_sends 1         Hostname sent by client
        ip4_field src_ip 2
        str_field resolved 3             Hostname resolved by the server
      </fieldmatch>

      <fieldmatch "^Bad protocol version identification '([^']+)' from ([0-9.]+)">
        str_field bad_proto 1            Bad protocol string received by the server
        ip4_field src_ip 2
      </fieldmatch>

      <fieldmatch "^Connection closed by ([0-9.]+)">
        ip4_field close_from 1           IP source address of connection closure
      </fieldmatch>

      <fieldmatch "^Received disconnect from ([0-9.]+): 13: The user canceled authentication.">
        ip4_field disconnect_from 1      Auth cancellation from IP
      </fieldmatch>

      <fieldmatch "^Did not receive identification string from ([0-9.]+)">
        ip4_field no_clistr_from 1       No client string from IP
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "sudo">
    <vmod sudo>
      <fieldmatch "^ *([^ ]+) : TTY=([^ ]+) ; PWD=([^ ]+) ; USER=([^ ]+) ; COMMAND=(.+)">
        str_field caller 1       User who called sudo
        str_field tty 2          Pseudo terminal where user is logged
        str_field workdir 3      Current working directory
        str_field user 4         Destination user set by sudo
        str_field cmd 5          Requested command line
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "tftpd">
    <vmod tftpd>
      <fieldmatch "^Serving ([^ ]+) to ([0-9.]+):([0-9]+)">
        str_field file 1         File requested
        ip4_field host 2         Client IP address
        int_field port 3         Client TCP port
      </fieldmatch>

      <fieldmatch "^Trivial FTP server (start)ed \(([0-9.]+)\)">
        str_field action 1       Server action
        str_field version 2      Software version
      </fieldmatch>

      <fieldmatch "Main thread (exit)ing">
        str_field action 1
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "imapd">
    <vmod imapd>
      <fieldmatch "^Login failed user=([^ ]+) auth=([^ ]+) host=([^ ]+) \[([0-9.]+)\]">
        str_field user 1       User login
        str_field auth 2       Authentification method
        str_field host 3       Remote client hostname
        ip4_field ip   4       Remote client IP address
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "rpc.yppasswdd">
    <vmod yppasswdd>
      <fieldmatch "^update ([^ ]+) \(uid=([0-9]+)\) from host ([0-9.]+) successful.">
        str_field user 1       User login
        int_field uid  2       User identifier
        ip4_field from 3       IP source host
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "pam_rhosts_auth">
    <vmod pam_rhost>
      <fieldmatch "^(allow)ed to ([^@]+)@([^ ]+) as ([^ ]+)">
        str_field action 1     Authentification action
        str_field ruser 2      Remote user name
        str_field rhost 3      Remote host name
        str_field user  4      Requested local user name
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "rsh(pam_unix)">
    <vmod pam_rsh>
      <fieldmatch "^session (open)ed for user ([^ ]+) by \(uid=([0-9]+)\)">
        str_field action 1      Authentification action
        str_field user  2       User login
        int_field uid   3       User identifier
      </fieldmatch>

      <fieldmatch "^session (close)d for user ([^ ]+)">
        str_field action 1
        str_field user  2
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "in.rshd">
    <vmod rshd>
      <fieldmatch "^([^@]+)@([^ ]+) as ([^:]+): cmd='(.*)'$">
        str_field ruser 1          Remote user login
        str_field rhost 2          Remote client host
        str_field user 3           Requested local user
        str_field cmd 4            Requested command line
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "afpd">
    <vmod afpd>
      <fieldmatch "^login ([^ ]+) \(uid ([0-9]+), gid ([0-9]+)\) (AFP[0-9.]+)">
        str_field login 1          User login
        int_field uid 2            User identifier
        int_field gid 3            User group identifier
        str_field proto 4          Apple Filesharing Protocol version
      </fieldmatch>

      <fieldmatch "^logout ([^ ]+)">
        str_field logout 1         User logout
      </fieldmatch>

      <fieldmatch "^([0-9]+)\.[0-9]+KB read, ([0-9]+)\.[0-9]+KB written">
        int_field read 1            Bytes read by server during the connexion
        int_field write 2           Bytes written by server during the connexion
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "named">
    <vmod named>

      <fieldmatch "^lame-servers: info: lame server resolving '([^']+)' \(in '([^']+)'\?\): ([0-9.]+)#([0-9]+)">
        str_field resolve 1       Erronous resolved name
        str_field in 2            Name server zone
        ip4_field srv_ip 3        Lame server IP address
        int_field srv_port 4      Lame server UDP port
      </fieldmatch>

      <fieldmatch "^xfer-out: info: client ([0-9.]+)#([0-9]+): transfer of '([^']+)': AXFR started">
        ip4_field cli_ip 1        IP address of the zone transfer requester
        int_field cli_port 2      TCP port of the zone transfer requester
        str_field zone 3          Requested zone for the transfer
      </fieldmatch>

      <fieldmatch "^notify: info: zone ([^:]+): sending notifies \(serial ([0-9]+)\)">
        str_field zone_notify 1   Zone which send a notify
        str_field serial 2        Serial number sent
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "arpwatch">
# flip flop 138.231.81.215 8:0:86:17:96:ff (0:4:0:12:20:6e)
# bogon 0.0.0.0 0:a:95:94:67:6c
# new activity 138.231.81.210 8:0:86:15:6d:f1
# new station 138.231.81.169 0:a:95:cd:64:0
# changed ethernet address 138.231.81.254 0:d:56:72:9e:b5 (0:8:74:97:34:d7)
# ethernet broadcast 10.0.x.x ff:ff:ff:ff:ff:ff

    <vmod arpwatch>

      <fieldmatch "^(bogon) ([0-9.]+) ([0-9a-fA-F]+)">
        str_field msg 1     ArpWatch event category
        ip4_field ip 2      IP address
        str_field mac 3     MAC address
      </fieldmatch>

      <fieldmatch "^(flip flop) ([0-9.]+) ([0-9a-fA-F]+) \(([0-9a-fA-F]+)\)">
        str_field msg 1
        ip4_field ip 2
        str_field mac 3
        str_field old_mac 4  Old MAC address
      </fieldmatch>

      <fieldmatch "^(new activity) ([0-9.]+) ([0-9a-fA-F]+)">
        str_field msg 1
        ip4_field ip 2
        str_field mac 3
      </fieldmatch>

      <fieldmatch "^(new station) ([0-9.]+) ([0-9a-fA-F]+)">
        str_field msg 1
        ip4_field ip 2
        str_field mac 3
      </fieldmatch>

      <fieldmatch "^(changed ethernet address) ([0-9.]+) ([0-9a-fA-F]+) \(([0-9a-fA-F]+)\)">
        str_field msg 1
        ip4_field ip 2
        str_field mac 3
        str_field old_mac 4
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "popa3d">
    <vmod popa3d>
      <fieldmatch "^Authentication passed for ([^ ]+)">
        str_field auth_user 1          User login authentified
      </fieldmatch>

      <fieldmatch "^([0-9]+) message[s]? \(([0-9]+) bytes\) loaded">
        int_field msgs 1               Messages retrieved
        int_field bytes 2              Total size of the transfer
      </fieldmatch>

      <fieldmatch "^([0-9]+) \(([0-9]+)\) deleted, ([0-9]+) \(([0-9]+)\) left">
        int_field del_msgs 1            Messages deleted
        int_field del_bytes 2           Size deleted
        int_field left_msgs 3           Message left in mail spool
        int_field left_bytes 4          Size left in mail spool
      </fieldmatch>

      <fieldmatch "^(Another MUA active, giving up)">
        str_field error_msg 1           Error message
      </fieldmatch>

      <fieldmatch "^(Connection timed out)">
        str_field error_msg 1
      </fieldmatch>

      <fieldmatch "^(Didn't attempt authentication)">
        str_field error_msg 1
      </fieldmatch>

      <fieldmatch "^(Premature disconnect)">
        str_field error_msg 1
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "dhcpd">
    <vmod dhcpd>
      <fieldmatch "^(DHCPREQUEST) for ([0-9.]+) from ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1        DHCP method
        ip4_field ip 2            Client IP address
        str_field mac 3           Client Ethernet MAC address
        str_field if 4            Interface used by the DHCP server
      </fieldmatch>

      <fieldmatch "^(DHCPACK) on ([0-9.]+) to ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1
        ip4_field ip 2
        str_field mac 3
        str_field if 4
      </fieldmatch>

      <fieldmatch "^(DHCPDISCOVER) from ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1
        str_field mac 2
        str_field if 3
      </fieldmatch>

      <fieldmatch "^(DHCPOFFER) on ([0-9.]+) to ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1
        ip4_field ip 2
        str_field mac 3
        str_field if 4
      </fieldmatch>

      <fieldmatch "^(DHCPNAK) on ([0-9.]+) to ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1
        ip4_field ip 2
        str_field mac 3
        str_field if 4
      </fieldmatch>

      <fieldmatch "^(DHCPRELEASE) of ([0-9.]+) from ([0-9a-fA-F:]+) via ([^ ]+)">
        str_field method 1
        ip4_field ip 2
        str_field mac 3
        str_field if 4
      </fieldmatch>

      <fieldmatch "^(DHCPINFORM) from ([0-9.]+)">
        str_field method 1
        ip4_field ip 2
      </fieldmatch>

      <fieldmatch "^no free leases on subnet ([0-9.]+)">
        ip4_field no_leases_on 1   No free lease on subnet
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "rsyncd">
    <vmod rsyncd>

      <fieldmatch "^rsync on ([^ ]+) from ([^ ]+) \(([0-9.]+)\)">
        str_field on 1                     Path exported by the server
        str_field from_host 2              Client host name
        ip4_field from_ip 3                Client IP address
      </fieldmatch>

      <fieldmatch "^wrote ([0-9]+) bytes  read ([0-9]+) bytes  total size ([0-9]+)">
        int_field wrote 1                  Bytes written
        int_field read 2                   Bytes read
        int_field total 3                  Totals transfer size
      </fieldmatch>

      <fieldmatch "rsync error: (.*)">
        str_field error 1                   Error message
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "automount">
    <vmod automount>
      <fieldmatch "^attempting to mount entry ([^ ]*)">
        str_field mount 1              Mount point attempted to be mounted
      </fieldmatch>

      <fieldmatch "^expired ([^ ]*)">
        str_field expired 1           Mount point expiration
      </fieldmatch>

      <fieldmatch "^starting automounter version ([0-9.]+), path = ([^,]*), maptype = ([^,]*), mapname = ([^, ]*)">
        str_field version 1            Automounter version
        str_field path 2               Path added to the mount point list
        str_field maptype 3            Map type
        str_field mapname 4            Map name
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "xinetd">
    <vmod xinetd>
      <fieldmatch "^(START): ([^ ]+) pid=([0-9]+) from=([0-9.]+)">
        str_field action  1            Information on the action
        str_field service 2            Service started
        int_field pid 3                Process identifier of the daemon process
        ip4_field from 4               IP address which requested the service
      </fieldmatch>

      <fieldmatch "^(EXIT): ([^ ]+) pid=([0-9]+) duration=([0-9]+)\(sec\)">
        str_field action 1
        str_field service 2
        int_field pid 3
        int_field duration 4           Duration of the transaction
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "CROND">
    <vmod crond>
      <fieldmatch "^\(([^)]*)\) CMD \(([^)]*)\)">
        str_field user 1               User which execute the job
        str_field cmd 2                Executed command
      </fieldmatch>
    </vmod>
  </hook>

# postfix/cleanup: Canonicalize and enqueue Postfix message
  <hook syslog "postfix/cleanup">
    <vmod postfix_cleanup>
      <fieldmatch "^([^:]+): message-id=(<[^>]*>)">
        str_field queue_id 1         Queue identifier
        str_field msg_id 2           Message identifier
      </fieldmatch>
    </vmod>
  </hook>

# postfix/local: Postfix local mail delivery
  <hook syslog "postfix/local">
    <vmod postfix_local>

      <fieldmatch "^([^:]+): to=(<[^>]*>), orig_to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(forwarded as ([^)]+)\)">
        str_field queue_id 1          Queue identifier
        str_field to 2                Destination mail address (To:)
        str_field orig_to 3           Original destination (before rewrite)
        str_field relay 4             Relay name
        int_field delay 5             Delay value
        str_field status 6            Status of the transaction
        str_field fwd_as 7            Forward information
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), orig_to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(\"\|([^\"]+)\"\)">
        str_field queue_id 1
        str_field to 2
        str_field orig_to 3
        str_field relay 4
        int_field delay 5
        str_field status 6
        str_field pipe_cmd 7           Pipe command
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), orig_to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1
        str_field to 2
        str_field orig_to 3
        str_field relay 4
        int_field delay 5
        str_field status 6
        str_field message 7           Additionnal message
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(forwarded as ([^)]+)\)">
        str_field queue_id 1
        str_field to 2
        str_field relay 3
        int_field delay 4
        str_field status 5
        str_field fwd_as 6
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(\"\|([^\"]+)\"\)">
        str_field queue_id 1
        str_field to 2
        str_field relay 3
        int_field delay 4
        str_field status 5
        str_field pipe_cmd 6
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1
        str_field to 2
        str_field relay 3
        int_field delay 4
        str_field status 5
        str_field message 6
      </fieldmatch>
    </vmod>
  </hook>

# postfix/master: Postfix master process
#  <hook syslog "postfix/master">
#  </hook>

# postfix/pickup: Postfix local mail pickup
  <hook syslog "postfix/pickup">
    <vmod postfix_pickup>
      <fieldmatch "^([^:]+): uid=([0-9]+) from=(<[^>]*>)">
        str_field queue_id 1        Queue identifier
        int_field user_id 2         User identifier
        str_field from 3            Source recipient
      </fieldmatch>
    </vmod>
  </hook>

# postfix/qmgr: Postfix queue manager
  <hook syslog "postfix/nqmgr">
    <vmod postfix_nqmgr>
      <fieldmatch "^([^:]+): from=(<[^>]*>), size=([0-9]*), nrcpt=([0-9]*) \(([^)]*)\)">
        str_field queue_id 1           Queue identifier
        str_field from 2               Sender mail address (From:)
        str_field size 3               Size of the message
        str_field nrcpt 4              Number of recipients
        str_field status 5             Status of the transaction
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1
        str_field to 2                 Destination mail address
        str_field relay 3              Relay name
        int_field delay 4              Delay value
        str_field status 5
        str_field message 6            Additionnal message
      </fieldmatch>

    </vmod>
  </hook>

# postfix/showq: list the Postfix mail queue
#  <hook syslog "postfix/showq">
#  </hook>

# postfix/smtp: Postfix remote delivery via SMTP
  <hook syslog "postfix/smtp">
    <vmod postfix_smtp>

      <fieldmatch "^([^:]+): to=(<[^>]*>), orig_to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1           Queue identifier
        str_field to 2                 Destination mail address (To:)
        str_field orig_to 3            Original destination address (before rewrite)
        str_field relay 4              Relay name
        int_field delay 5              Delay value
        str_field status 6             Status of the transaction
        str_field message 7            Additionnal message
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1
        str_field to 2
        str_field relay 3
        int_field delay 4
        str_field status 5
        str_field message 6
      </fieldmatch>
    </vmod>
  </hook>

# postfix/smtpd: Postfix SMTP server
  <hook syslog "postfix/smtpd">
    <vmod postfix_smtpd>
      <fieldmatch "^connect from (.*)">
        str_field connect_from 1    Connection from host
      </fieldmatch>

      <fieldmatch "^([^:]+): client=(.*)">
        str_field queue_id 1        Queue identifier
        str_field client 2          Client information
      </fieldmatch>

      <fieldmatch "^disconnect from (.*)">
        str_field disconnect_from 1   Disconnection from host
      </fieldmatch>

      <fieldmatch "^([^:]+): reject: RCPT from ([^[]*)\[([0-9.]+)\]: (.*)">
        str_field queue_id 1       Queue identifier
        str_field from_host 2      Host name rejected
        ip4_field from_ip 3        IP address rejected
        str_field err_msg 4        Additionnal error message
      </fieldmatch>

      <fieldmatch "^reject: RCPT from ([^:]*)">
        str_field reject_from 1    Unresolved rejection
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "postfix/error">
    <vmod postfix_error>
      <fieldmatch "^([^:]+): to=(<[^>]*>), orig_to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1       Queue identifier
        str_field to 2             Destination mail address (To:)
        str_field orig_to 3        Original destination address (before rewrite)
        str_field relay 4          Relay name
        int_field delay 5          Delay value
        str_field status 6         Status of the transaction
        str_field message 7        Additionnal message
      </fieldmatch>

      <fieldmatch "^([^:]+): to=(<[^>]*>), relay=([^,]*), delay=([0-9]*), status=([^ ]*) \(([^)]*)\)">
        str_field queue_id 1
        str_field to 2
        str_field relay 3
        int_field delay 4
        str_field status 5
        str_field message 6
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "login(pam_unix)">
    <vmod pam_login>
      <fieldmatch "^session opened for user ([^)]+) by ([^)]+)\(uid=([0-9]+)\)">
        str_field dest_user 1        Identity of the opened session
        str_field src_user 2         Identity that requested the session
        int_field src_uid 3          User identifier that requested the session
      </fieldmatch>

      <fieldmatch "^session closed for user \(.+\)$">
        str_field dest_user 1         User who close the session
      </fieldmatch>

      <fieldmatch "^authentication failure; logname=\([^ ]+\) uid=\([0-9]+\) euid=\([0-9]+\) tty=\([^ ]+\) ruser=\([^ ]*\) rhost=\([^ ]*\)  user=\([^ ]*\)$">
        str_field logname 1   Login name that failed the authentification
        int_field uid     2   User identifier corresponding to the login
        int_field euid    3   Effective user identifier
        str_field tty     4   Pseudo terminal
        str_field ruser   5   Remote user
        str_field rhost   6   Remote host
        str_field user    7   User name
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "kernel">
    <vmod nfhub>
      <fieldmatch "^fw:([^:]+):([^:]+):([^:]+):(.+)">
        str_field acl 1        Access Control List
        str_field action 2     Action (accept/drop/reject/log)
        str_field desc 3       Brief description
        str_field nf_msg 4     Complete Linux NetFilter message
      </fieldmatch>
    </vmod>

    <vmod promisc>
      # promisc mode entrance
      <fieldmatch "^device ([^ ]+) (enter)ed promiscuous mode">
        str_field action 2       Action of the network driver
        str_field interface 1    Interface which entered/left promisc mode
      </fieldmatch>

      # promisc mode leaving
      <fieldmatch "^device ([^ ]+) (left) promiscuous mode">
        str_field action 2
        str_field interface 1
      </fieldmatch>
    </vmod>

    # Linux NetFilter (iptables)
#    <vmod iptables>
#      # TCP Drop
#      <fieldmatch "regex">
#        # XXX DEFINE All Fields
#        # "Drop IN=(\w*) OUT=(\w*) (MAC=[\w:]+)? SRC=([\d\.]+) DST=([\d\.]+) LEN=(\d+) TOS=(\w+) PREC=(\w+) TTL=(\d+) ID=(\d+) (CE )?(DF )?(MF )?(FRAG:\d+ )?(OPT \(\w+\) )?PROTO=TCP (INCOMPLETE \[\d+ bytes\] )?SPT=(\d+) DPT=(\d+) (SEQ=\d+ ACK=\d+ )?WINDOW=(\d+) RES=(\w+) (CWR )?(ECE )?(URG )?(ACK )?(PSH )?(RST )?(SYN )?(FIN )?URGP=(\d+) (OPT \(\w+\) )?.*"
#        str_field in 1
#        str_field out 2
#      </fieldmatch>

      # UDP Match
#      <fieldmatch "regex">
#        # XXX DEFINE All Fields
#        #"Drop IN=(\w*) OUT=(\w*) (MAC=[\w:]+)? SRC=([\d\.]+) DST=([\d\.]+) LEN=(\d+) TOS=(\w+) PREC=(\w+) TTL=(\d+) ID=(\d+) (CE )?(DF )?(MF )?(FRAG:\d+ )?(OPT \(\w+\) )?PROTO=UDP (INCOMPLETE \[\d+ bytes\] )?SPT=(\d+) DPT=(\d+) LEN=(\d+).*"
#        str_field in 1
#        str_field out 2
#      </fieldmatch>

      # ICMP Drop
#      <fieldmatch "regex">
#        # XXX DEFINE All Fields
#        # "Drop IN=(\w*) OUT=(\w*) (MAC=[\w:]+)? SRC=([\d\.]+) DST=([\d\.]+) LEN=(\d+) TOS=(\w+) PREC=(\w+) TTL=(\d+) ID=(\d+) (CE )?(DF )?(MF )?(FRAG:\d+ )?(OPT \(\w+\) )?PROTO=ICMP (INCOMPLETE \[\d+ bytes\] )?TYPE=(\d+) CODE=(\d+) (INCOMPLETE \[\d+ bytes\] )?(ID=\d+ SEQ=\d+ )?(PARAMETER=\d+ )?(GATEWAY=[\d\.]+ )?(\[\w+\])?(MTU=\d+ )?.*"
#        str_field in 1
#        str_field out 2
#      </fieldmatch>
#    </vmod>
  </hook>

  # modprobe messages
  <hook syslog "modprobe">
    <vmod modprobe>
      <fieldmatch "^modprobe: Can't locate module ([^ ]+)">
        str_field mod_not_found 1        Requested module not found
      </fieldmatch>

      <fieldmatch "^FATAL: Error running install command for ([^ ]+)">
        str_field install_err 1          Error during installation
      </fieldmatch>

    </vmod>
  </hook>

#  <hook textfile "/import/olivain/work/orchids/src/access_log">
  <hook syslog "httpd">
    <vmod apache>
      <fieldmatch "^([^ ]+) +([^ ]+) +([^ ]+) +\[([^]]+)\] +\"([^ ]+) +([^ "]+) +([^"]*)\" +([0-9]+) +([0-9]+) +\"(http://www\.google\.[a-zA-Z]+/search\?([^"]+))\" +\"([^"]+)\"">
        str_field host 1              IP address/hostname of the client
        str_field ident 2             Identification
        str_field userid 3            User identity
        str_field date 4              Date and time of the transaction
        str_field http_method 5       HTTP protocol method
        str_field http_uri 6          Requested universal resource identifier
        str_field http_version 7      HTTP protocol version
        int_field http_status 8       Transaction status code
        int_field http_size 9         Size of the transaction (in bytes)
        str_field referer 10          HTTP referer
        str_field google_query 11     Google query
        str_field user_agent 12       User agent
      </fieldmatch>


      <fieldmatch "^([^ ]+) +([^ ]+) +([^ ]+) +\[([^]]+)\] +\"([^ ]+) +([^ "]+) +([^"]*)\" +([0-9]+) +([0-9-]+) +\"([^"]+)\" +\"([^"]+)\"">
        str_field host 1
        str_field ident 2
        str_field userid 3
        str_field date 4
        str_field http_method 5
        str_field http_uri 6
        str_field http_version 7
        int_field http_status 8
        int_field http_size 9
        str_field referer 10
        str_field user_agent 11
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "httpsd">
    <vmod apachessl>
      <fieldmatch "^\[([^]]+)\] +([^ ]+) +([^ ]+) +([^ ]+) +\"([^ ]+) +([^ "]+) +([^"]*)\" +([0-9]+)">
        str_field date 1           Date and time of the transaction
        str_field host 2           Client host address
        str_field proto 3          Protocol
        str_field ciphers 4        Ciphers
        str_field http_method 5    HTTP protocol method
        str_field http_uri 6       Requested universal resource identifier
        str_field http_version 7   HTTP protocol version
        int_field http_size 8      Size of the transaction (in bytes)
      </fieldmatch>
    </vmod>
  </hook>

# authenticated mount request from mangue:707 for /local/home/roger (/local/home)
# authenticated unmount request from nectarine:1007 for /local/home/mail (/local/home)
# export request from 138.231.81.247
  <hook syslog "rpc.mountd">
    <vmod rpcmountd>
      <fieldmatch "^authenticated (mount|unmount) request from ([^:]+):([0-9]+) for ([^ ]+) \(([^)]+)\)">
        str_field action 1         Action (mount/unmount)
        str_field src_host 2       Source host
        int_field port 3           TCP source port
        str_field path 4           Path to be mounted
        str_field wd 5             Working directory
      </fieldmatch>

      <fieldmatch "^export request from ([0-9.]+)">
        ip4_field exp_req 1         IP address that made an export request
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "pop3-login">
    <vmod pop3login>
      <fieldmatch "^Login: ([^ ]+) \[([0-9.]+)\]">
        str_field  login 1     Login
        ip4_field src_ip 2     IP source address
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "imap-login">
    <vmod imaplogin>
      <fieldmatch "^Login: ([^ ]+) \[([0-9.]+)\]">
        str_field  login 1      Login
        ip4_field src_ip 2      IP source address
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "ntpd">
    <vmod ntpd>
      <fieldmatch "^(synchronized) to ([0-9.]+), stratum=([0-9]+)">
        str_field msg 1       Message
        ip4_field ref 2       Reference clock
        int_field stratum 3   Stratum of the reference clock
      </fieldmatch>

      <fieldmatch "^(synchronisation lost)">
        str_field msg 1
      </fieldmatch>

      <fieldmatch "^(no servers reachable)">
        str_field msg 1
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "snort">
    <vmod snort>
      <fieldmatch "^\[([0-9]+):([0-9]+):([0-9]+)\] ([^ ]+) ([^[]+)\[Classification: ([^]]+)\] \[Priority: ([0-9]+)\]: \{(TCP|UDP)\} ([0-9.]+):([0-9]+) -> ([0-9.]+):([0-9]+)">
        int_field gen 1      Generic identifier
        int_field id 2       Identifier
        int_field rev 3      Revision
        str_field category 4 Category
        str_field desc 5     Description
        str_field class 6    Class
        int_field prio 7     Priority
        str_field proto 8    Protocol
        ip4_field sip 9      IP source address
        int_field spt 10     TCP/UDP source port
        ip4_field dip 11     IP destination addess
        int_field dpt 12     TCP/UDP destination port
      </fieldmatch>

      <fieldmatch "^\[([0-9]+):([0-9]+):([0-9]+)\] ([^ ]+) ([^[]+)\[Classification: ([^]]+)\] \[Priority: ([0-9]+)\]: \{(ICMP)\} ([0-9.]+) -> ([0-9.]+)">
        int_field gen 1
        int_field id 2
        int_field rev 3
        str_field category 4
        str_field desc 5
        str_field class 6
        int_field prio 7
        str_field proto 8
        ip4_field sip 9
        ip4_field dip 10
      </fieldmatch>

      <fieldmatch "^spp_portscan: (PORTSCAN DETECTED) from ([0-9.]+) \(THRESHOLD ([0-9]+) connections exceeded in ([0-9]+) seconds\)">
	str_field message 1        Message of the snort module
	ip4_field sip 2
	int_field threshold 3      Threshold reached in the time period
	int_field period 4         Time period in second
      </fieldmatch>

      <fieldmatch "^spp_portscan: (portscan status) from ([0-9.]+): ([0-9]+) connections across ([0-9]+) hosts: TCP\(([0-9]+)\), UDP\(([0-9]+)\)">
        str_field message 1
        ip4_field sip 2
        int_field nb_conn 3      Number of connections
        int_field nb_host 4      Number of hosts reached
        int_field nb_tcp 5       Number of TCP connections
        int_field nb_udp 6       Number of UDP connections
      </fieldmatch>

      <fieldmatch "^spp_portscan: (End of portscan) from ([0-9.]+): TOTAL time\(([0-9]+)s\) hosts\(([0-9]+)\) TCP\(([0-9]+)\) UDP\(([0-9]+)\)">
        str_field message 1
        ip4_field sip 2
        int_field total_time 3     Total time of the scan
        int_field nb_host 4
        int_field nb_tcp 5
        int_field nb_udp 6
      </fieldmatch>

    </vmod>
  </hook>

  <hook syslog "httpsd_error">
    <vmod sslerror>
     <fieldmatch "^\[([^]]+)\] \[([^]]+)\] (mod_ssl): (SSL handshake failed) \(server ([^:]+):([0-9]+), client ([0-9.]+)\) \(OpenSSL library error follows\)">
        str_field date 1        Event date
        str_field severity 2    Event severity
        str_field module 3      Source module
        str_field message 4     Message
        str_field srv_addr 5    Server address
        int_field srv_port 6    Server port
        ip4_field cli_addr 7    Client address
      </fieldmatch>

      <fieldmatch "^\[([^]]+)\] \[([^]]+)\] (OpenSSL): ([^:]+):([0-9A-F]+):lib\(([0-9]+)\):func\(([0-9]+)\):reason\(([0-9]+)\)">
        str_field date 1
        str_field severity 2
        str_field module 3
        str_field message 4
        str_field openssl_code 5      OpenSSL error code
        int_field openssl_lib 6       OpenSSL library identifier
        int_field openssl_func 7      OpenSSL function identifier
        int_field openssl_reason 8    OpenSSL error detail
      </fieldmatch>

      <fieldmatch "^\[([^]]+)\] \[([^]]+)\] ([^:]+): (.*)">
        str_field date 1
        str_field severity 2
        str_field module 3
        str_field message 4
      </fieldmatch>
    </vmod>
  </hook>

  <hook syslog "net-entropy">
    <vmod entropy>
      <fieldmatch "^(RISING ALARM) on ([0-9.]+):([0-9]+) -> ([0-9.]+):([0-9]+) offset=([0-9]+) packets=([0-9]+) entropy=([0-9.]+)">
        str_field message 1      Entropy checker daemon message
        ip4_field src_ip 2       Source IP address
        int_field src_port 3     Source port address
        ip4_field dst_ip 4       Destination IP address
        int_field dst_port 5     Destination port address
        int_field offset 6       Number of bytes since the connection begin
        int_field packets 7      Number of packets since the connection begin
        flt_field entropy 8      Statistical entropy of data of this connection
      </fieldmatch>

      <fieldmatch "^(Falling alarm) on ([0-9.]+):([0-9]+) -> ([0-9.]+):([0-9]+) offset=([0-9]+) packets=([0-9]+) entropy=([0-9.]+)">
        str_field message 1
        ip4_field src_ip 2
        int_field src_port 3
        ip4_field dst_ip 4
        int_field dst_port 5
        int_field offset 6
        int_field packets 7
        flt_field entropy 8
      </fieldmatch>

      <fieldmatch "^(Stop tracking) ([0-9.]+):([0-9]+) -> ([0-9.]+):([0-9]+) offset=([0-9]+) packets=([0-9]+)">
        str_field message 1
        ip4_field src_ip 2
        int_field src_port 3
        ip4_field dst_ip 4
        int_field dst_port 5
        int_field offset 6
        int_field maxdata 7      Data limit
        int_field packets 8
      </fieldmatch>

      <fieldmatch "^(End of connection) ([0-9.]+):([0-9]+) -> ([0-9.]+):([0-9]+) offset=([0-9]+) packets=([0-9]+) \(([^)]+)\)">
        str_field message 1
        ip4_field src_ip 2
        int_field src_port 3
        ip4_field dst_ip 4
        int_field dst_port 5
        int_field offset 6
        int_field packets 7
        str_field reason 8         Reason of the end of connection
      </fieldmatch>
    </vmod>
  </hook>

</module>
